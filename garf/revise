#!/bin/sh

posts="$(   ~/scripts/cmd/garf +dir 'posts'    || exit 1)"
unedited="$(~/scripts/cmd/garf +dir 'unedited' || exit 1)"
old="$(     ~/scripts/cmd/garf +dir 'old'      || exit 1)"

cd "$posts" || exit 1

post="$1"

if [ ! "$post" ]; then
    # Get first post id with errata file
    for i in *; do
        if [ -f "$i/errata" ]; then
            post="$i"
            break
        fi
    done

    # No post to revise!
    if [ ! "$post" ]; then
        echo 'garf revise: no posts with errors'
        exit 0
    fi

    echo "Post id: $post"
fi

# Invalid post id
if [ ! -d "$post" ]; then
    echo 'garf revise: no post with that id'
    exit 1
fi

# Find date if not existing file
if [ ! -f "$post/date" ]; then
    echo 'No date file, please find from post'
    ~/scripts/cmd/garf date "$post" || exit "$?"
fi

# Read date file (existing or just created)
date="$(cat "$post/date")"
echo "Date: $date"

# Show errors
if [ -f "$post/errata" ]; then
    echo 'Errors:'
    sed -e '/^ *$/d' -e 's/^/ * /' "$post/errata"
else
    echo 'No errors'
fi

# Make post
~/scripts/cmd/garf make "$date" "$post" || exit "$?"

# Copy title and props files
cp "$post/title"  "$unedited/$post/title" || exit 1

# Copy existing props file
if [ -f "$post/props" ]; then
    cp "$post/props"  "$unedited/$post/props" || exit 1
fi
# Append 'revised' to properties file
echo 'revised' >> "$unedited/$post/props" || exit 1

# Move old post to old
printf 'Move old post to old folder? (CTRL-C to cancel) '
read -r
mv "$post" "$old/" || exit
echo "Moved $post to old folder"

